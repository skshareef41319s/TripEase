<% layout("/layouts/boilerplate") %>

<body>
  <div class="container">
    <!-- Listing Detail Card -->
    <div class="card detail-card">
      <img
        src="<%= listing.image.url %>"
        alt="Destination Image"
        class="card-image"
      />
      <div class="card-content">
        <h1 class="card-title"><%= listing.title %></h1>
        <p class="card-subtext">
          <%= listing.location %>, <%= listing.country %>
        </p>
        <p class="card-description"><%= listing.description %></p>
        <p class="card-price">Price: $<%= listing.price %></p>
      </div>
    </div>

    <!-- Like/Unlike Button -->
    <div class="like-unlike-btn">
      <% if (!currentUser || !currentUser.likedListings.includes(listing._id)) { %>
        <form action="/listings/<%= listing._id %>/like" method="POST">
          <button type="submit" class="emoji-btn" title="Like this destination">‚ù§Ô∏è</button>
        </form>
      <% } else { %>
        <form action="/listings/<%= listing._id %>/unlike" method="POST">
          <button type="submit" class="emoji-btn liked" title="Unlike this destination">üíî</button>
        </form>
      <% } %>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons mt-4 d-flex flex-wrap gap-3 justify-content-center">
      <a href="/listings/<%= listing._id %>/edit" class="btn btn-primary px-4">Edit</a>

      <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST" class="form-css delete-listing-form">
        <button type="submit" class="btn btn-danger px-4 d-flex align-items-center justify-content-center">
          <i class="bi bi-trash"></i> Delete
        </button>
      </form>

      <form action="/listings/<%= listing._id %>/book" method="POST" class="booking-form">
        <div class="booking-group">
          <label for="date">Date</label>
          <input type="date" name="date" id="date" required class="booking-input" />
        </div>

        <div class="booking-group">
          <label for="guests">Guests</label>
          <input type="number" name="guests" id="guests" min="1" value="1" required class="booking-input" />
        </div>

        <button type="submit" class="btn btn-book align-self-center">
          <i class="fas fa-check-circle me-1"></i> Book Now
        </button>
      </form>

      <a href="/listings" class="btn btn-outline-secondary px-4">Back to Destinations</a>
    </div>

    <!-- Reviews Section -->
    <div class="review-section mt-5">
      <h3 class="mb-3">Reviews</h3>

      <!-- Leave a Review Form -->
      <form action="/listings/<%= listing._id %>/reviews" method="POST" class="review-form mb-4">
        <div class="form-group">
          <label for="reviewText">Your Comment</label>
          <textarea id="reviewText" name="review[comment]" placeholder="Share your experience..." required></textarea>
        </div>
        <div class="form-group rating-group">
          <label>Your Rating</label>
          <div class="star-rating">
            <% for(let i = 5; i >= 1; i--) { %>
              <input type="radio" id="star-<%= i %>" name="review[rating]" value="<%= i %>" required />
              <label for="star-<%= i %>">&#9733;</label>
            <% } %>
          </div>
        </div>
        <button type="submit" class="btn btn-primary">Submit Review</button>
      </form>

      <!-- List of Reviews -->
      <% if(listing.reviews && listing.reviews.length > 0) { %>
        <div class="reviews-list mt-3">
          <% listing.reviews.forEach(review => { %>
            <div class="review-card">
              <p class="review-user">
                <% if(review.author && review.author.username) { %>
                  @<%= review.author.username %>
                <% } else { %>
                  @Unknown
                <% } %>
              </p>

              <p class="review-comment">"<%= review.comment %>"</p>

              <div class="review-rating">
                <% for(let i = 1; i <= 5; i++) { %>
                  <% if(i <= review.rating) { %>
                    <span class="star filled">&#9733;</span>
                  <% } else { %>
                    <span class="star">&#9734;</span>
                  <% } %>
                <% } %>
              </div>

              <!-- Delete button only for review author -->
              <% if(currentUser && review.author && review.author._id.equals(currentUser._id)) { %>
                <form action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="delete-review-form mt-2">
                  <button type="submit" class="btn btn-danger btn-sm">Delete Review</button>
                </form>
              <% } %>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <p class="text-muted">No reviews yet. Be the first to share your experience!</p>
      <% } %>
    </div>
  </div>

  <!-- CSS -->
  <style>
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #f9f9f9; color: #333; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: 3rem auto; padding: 0 1rem; }
    .detail-card { background: white; border-radius: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.12); overflow: hidden; display: flex; flex-direction: column; transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .detail-card:hover { transform: translateY(-8px); box-shadow: 0 16px 32px rgba(0,0,0,0.18); }
    .card-image { width: 100%; max-height: 350px; object-fit: cover; display: block; border-bottom: 1px solid #eee; }
    .card-content { padding: 1.8rem 2rem; }
    .card-title { font-size: 2.4rem; font-weight: 700; margin-bottom: 0.5rem; color: #2c3e50; }
    .card-subtext { font-size: 1.1rem; color: #777; margin-bottom: 1.5rem; font-style: italic; }
    .card-description { font-size: 1.25rem; line-height: 1.6; margin-bottom: 1.5rem; color: #444; }
    .card-price { font-size: 1.4rem; font-weight: 600; color: #28a745; }
    .action-buttons { margin-top: 2rem; gap: 1rem; }
    .btn { font-weight: 600; border-radius: 25px; font-size: 1.1rem; padding: 0.7rem 1.8rem; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; transition: background-color 0.3s ease; border: none; }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-danger:hover { background-color: #a71d2a; }
    .btn-outline-secondary { background-color: transparent; border: 2px solid #6c757d; color: #6c757d; }
    .btn-outline-secondary:hover { background-color: #6c757d; color: white; }
    .btn-book { background-color: #28a745; color: white; font-weight: 600; padding: 0.7rem 2rem; border-radius: 25px; border: none; transition: background-color 0.3s ease, transform 0.2s ease; }
    .btn-book:hover { background-color: #218838; transform: scale(1.05); }

    .review-section { margin-top: 3rem; padding: 2rem; background-color: #fff; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
    .review-form { display: flex; flex-direction: column; gap: 1.5rem; width: 100%; }
    .form-group label { font-weight: 600; margin-bottom: 0.5rem; display: inline-block; }
    .review-form textarea { width: 100%; border-radius: 10px; padding: 1rem; font-size: 1rem; border: 1px solid #ccc; resize: vertical; background: #f9f9f9; color: #333; transition: border 0.3s; }
    .review-form textarea:focus { border-color: #007bff; outline: none; }
    .rating-group { display: flex; flex-direction: column; gap: 0.5rem; }
    .star-rating { display: flex; flex-direction: row-reverse; justify-content: flex-start; gap: 0.3rem; }
    .star-rating input[type="radio"] { display: none; }
    .star-rating label { font-size: 2rem; color: #ccc; cursor: pointer; transition: color 0.3s ease; }
    .star-rating input[type="radio"]:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label { color: gold; }

    .reviews-list { margin-top: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; }
    .review-card { background-color: #fff; padding: 1rem 1.2rem; border-radius: 10px; border: 1px solid #ddd; width: calc(50% - 0.5rem); box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: transform 0.2s ease; }
    .review-card:hover { transform: translateY(-3px); }
    .review-user { font-weight: 600; font-size: 0.9rem; color: #007bff; margin-bottom: 0.3rem; }
    .review-comment { font-size: 0.85rem; font-style: italic; color: #333; margin-bottom: 0.5rem; }
    .review-rating .star { font-size: 1rem; color: #bbb; }
    .review-rating .filled { color: gold; }
    .btn-sm { font-size: 0.75rem; padding: 0.3rem 0.6rem; border-radius: 6px; }

    .booking-form { display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; justify-content: center; margin-top: 2rem; background-color: #ffffff; padding: 1.5rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); }
    .booking-group { display: flex; flex-direction: column; gap: 0.4rem; }
    .booking-group label { font-weight: 600; font-size: 0.95rem; color: #2c3e50; }
    .booking-input { padding: 0.6rem 1rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 8px; background-color: #f9f9f9; transition: border-color 0.3s ease; }
    .booking-input:focus { border-color: #007bff; outline: none; }
    .like-unlike-btn { display: flex; justify-content: flex-end; margin-top: 1rem; }
    .emoji-btn { font-size: 1.8rem; background: none; border: none; cursor: pointer; transition: transform 0.2s ease, color 0.3s ease; padding: 0.3rem 0.6rem; line-height: 1; border-radius: 50%; }
    .emoji-btn:hover { transform: scale(1.2); }
    .emoji-btn.liked:hover { color: #dc3545; }
    .emoji-btn:not(.liked):hover { color: #28a745; }
  </style>
 <!-- JS -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Confirm delete listing
      document.querySelectorAll("form.delete-listing-form").forEach(form => {
        form.addEventListener("submit", function(event){
          if(!confirm("Are you sure you want to delete this listing?")) event.preventDefault();
        });
      });

      // Confirm delete review
      document.querySelectorAll("form.delete-review-form").forEach(form => {
        form.addEventListener("submit", function(event){
          if(!confirm("Are you sure you want to delete this review?")) event.preventDefault();
        });
      });
    });
  </script>
</body>